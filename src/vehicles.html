<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HPS Vehicles</title>
    <link href="./bootstrap-5.2.3-dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="body">

    <header>
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="/">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/enterprises">Enterprises</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/vehicles">Vehicles</a>
              </li>
              <li class="nav-item">
                <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Drivers</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <h2>Vehicles list</h2>

    <form name="vehicleForm" class="row g-3" style="margin-left: 30px;margin-right: 30px;margin-top: 10px;margin-bottom: 10px;
    padding-left: 10px;padding-right: 10px;padding-top: 5px;padding-bottom: 5px;">
        <div class="col-md-4">
          <label for="inputBrandmodel" class="form-label">brandmodel_id</label>
          <input type="number" class="form-control" id="inputBrandmodel">
        </div>
        <div class="col-md-4">
            <label for="inputCost" class="form-label">cost</label>
            <input type="number" class="form-control" id="inputCost">
        </div>
        <div class="col-md-4">
            <label for="inputEnterpriseId" class="form-label">enterprise_id</label>
            <input type="text" class="form-control" id="inputEnterpriseId">
        </div>
        <div class="col-md-4">
            <label for="inputManufacturedYear" class="form-label">manufactured_year</label>
            <input type="number" class="form-control" id="inputManufacturedYear">
        </div>
        <div class="col-md-4">
              <label for="inputMileage" class="form-label">mileage</label>
              <input type="number" class="form-control" id="inputMileage">
        </div>
        <div class="col-md-2">
            <label for="readID" class="form-label">ID</label>
            <input class="form-control" id="readID" type="text" placeholder="Id wil be here..." readonly>
        </div>
        <div class="col-md-2">
            <label for="readCreatedAt" class="form-label">Created at</label>
            <input class="form-control" id="readCreatedAt" type="text" placeholder="Created at wil be here..." readonly>
        </div>
        <div class="mb-3">
            <label for="inputDescription" class="form-label">description</label>
            <textarea class="form-control" id="inputDescription" rows="3"></textarea>
        </div>

        <!-- <div class="col-md-4">
          <label for="inputState" class="form-label">State</label>
          <select id="inputState" class="form-select">
            <option selected>Choose...</option>
            <option>...</option>
          </select>
        </div> -->

        <div class="col-md-4 form-check form-switch">
            <!-- <div class="form-check form-switch"> -->
                <!-- <input type="hidden" name="checkbox" value="no" />   name="checkbox" value="yes" -->
                <input class="form-check-input" type="checkbox" id="isInWork" checked>
                <label class="form-check-label" for="isInWork">
                is_in_work
                </label>
        <!-- </div> -->
        </div>
        <div class="col-12 d-flex justify-content-between">
            <button type="submit" id="submitButton" class="btn btn-primary">Create or Update</button>
            <button type="button" id="deleteButton" class="btn btn-danger" >Delete</button>
            <button type="reset" id="resetButton" class="btn btn-secondary"">Reset</button>
          </div>
    </form>

    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Id</th>
                <th>brandmodel_id</th>
                <th>description</th>
                <th>melieage</th>
                <th>cost</th>
                <th>is_in_work</th>
                <th>manufactured_year</th>
                <th>enterprise_id</th>
                <th>created_at</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    
    <script>
        let vehicleId = 0;     // идентификатор Vehicle, который редактируется
        const vehicleForm = document.forms["vehicleForm"];    // форма ввода
        const bearer = sessionStorage.getItem("bearer");
        const domainUrl = "http://localhost:8001";
        const defaultQueryParams = "?page=0&size=100"
        // Получение всех пользователей
        async function getVehicles() {
            // отправляет запрос и получаем ответ
            const response = await fetch(domainUrl + "/vehicle/vehicles/" + defaultQueryParams, {
                method: "GET",
                headers: { "Accept": "application/json", "Authorization": `Bearer ${bearer}` }
            });
            // если запрос прошел нормально
            if (response.ok === true) {
                // получаем данные
                const responseData = await response.json();
                const vehicles = responseData.results
                const rows = document.querySelector("tbody"); 
                // добавляем полученные элементы в таблицу
                vehicles.forEach(vehicle => rows.append(row(vehicle)));
            }
        }
        // Получение одного Vehicle
        async function getVehicle(id) {
            const response = await fetch(domainUrl + "/vehicle/vehicles/" + id  + defaultQueryParams, {
                method: "GET",
                headers: { "Accept": "application/json", "Authorization": `Bearer ${bearer}` }
            });
            if (response.ok === true) {
                const vehicle = await response.json();
                vehicleId = vehicle.id;
                vehicleForm.elements["readID"].value = vehicle.id;
                vehicleForm.elements["inputBrandmodel"].value = vehicle.brandmodel_id;
                vehicleForm.elements["inputCost"].value = vehicle.cost;
                vehicleForm.elements["inputManufacturedYear"].value = vehicle.manufactured_year;
                vehicleForm.elements["isInWork"].checked = (vehicle.is_in_work === true ? true : false);
                vehicleForm.elements["inputDescription"].value = vehicle.description;
                vehicleForm.elements["inputEnterpriseId"].value = vehicle.enterprise_id;
                vehicleForm.elements["readCreatedAt"].value = vehicle.created_at;
                vehicleForm.elements["inputMileage"].value = vehicle.mileage;
            }
        }
        // Добавление Vehicle
        async function createVehicle(
            brandmodel_id,
            cost,
            manufactured_year,
            description,
            mileage,
            is_in_work,
            enterprise_id = null,
        ) {
            const requestBody = {
                brandmodel_id: parseInt(brandmodel_id),
                description: description,
                cost: parseInt(cost),
                manufactured_year: parseInt(manufactured_year),
                mileage: parseInt(mileage),
                is_in_work: Boolean(is_in_work),
                enterprise_id: parseInt(enterprise_id)
            };
            const response = await fetch(domainUrl + "/vehicle/vehicles/", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${bearer}`
                },
                body: JSON.stringify(requestBody)
            });
            if (response.ok === true) {
                const vehilcle = await response.json();
                reset();
                document.querySelector("tbody").append(row(vehilcle));
            }
        }
        // Изменение Vehicle
        async function editVehicle(
            id,
            brandmodel_id = null,
            cost = null,
            manufactured_year = null,
            description = null,
            mileage = null,
            enterprise_id = null,
            is_in_work = null
        ) {
            const response = await fetch(domainUrl + "/vehicle/vehicles/" + id  + defaultQueryParams, {
                method: "PATCH",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${bearer}`
                },
                body: JSON.stringify({
                    brandmodel_id: brandmodel_id,
                    description: description,
                    cost: cost,
                    manufactured_year: manufactured_year,
                    mileage: mileage,
                    is_in_work: Boolean(is_in_work),
                    enterprise_id: enterprise_id
                })
            });
            if (response.ok === true) {
                const vehicle = await response.json();
                reset();
                document.querySelector("tr[data-rowid='" + vehicle.id + "']").replaceWith(row(vehicle));
            }
        }
        // Удаление пользователя
        async function deleteVehicle(id) {
            const response = await fetch(domainUrl + "/vehicle/vehicles/" + id  + defaultQueryParams, {
                method: "DELETE",
                headers: { "Accept": "application/json", "Authorization": `Bearer ${bearer}` }
            });
            if (response.ok === true) {
                const vehicle = await response.json();
                document.querySelector("tr[data-rowid='" + vehicle.id + "']").remove();
            }
        }
   
        // сброс формы и текущего идентификатора пользователя
        function reset() {
            vehicleForm.reset();
            vehicleId = 0;
        }
        // создание строки для таблицы
        function row(vehicle) {
   
            const tr = document.createElement("tr");
            tr.setAttribute("data-rowid", vehicle.id);
   
            const idTd = document.createElement("td");
            idTd.append(vehicle.id);
            tr.append(idTd);

            const brandmodelTd = document.createElement("td");
            brandmodelTd.append(vehicle.brandmodel_id);
            tr.append(brandmodelTd);

            const descriptionTd = document.createElement("td");
            descriptionTd.append(vehicle.description);
            tr.append(descriptionTd);

            const mileageTd = document.createElement("td");
            mileageTd.append(vehicle.mileage);
            tr.append(mileageTd);

            const costTd = document.createElement("td");
            costTd.append(vehicle.cost);
            tr.append(costTd);

            const isInWorkTd = document.createElement("td");
            isInWorkTd.append(vehicle.is_in_work);
            tr.append(isInWorkTd);

            const manufacturedTd = document.createElement("td");
            manufacturedTd.append(vehicle.manufactured_year);
            tr.append(manufacturedTd);

            const enterpriseTd = document.createElement("td");
            enterpriseTd.append(vehicle.enterprise_id === null ? "" : vehicle.enterprise_id);
            tr.append(enterpriseTd);

            const createdAtTd = document.createElement("td");
            createdAtTd.append(vehicle.created_at);
            tr.append(createdAtTd);
               
            const linksTd = document.createElement("td");

            const editLink = document.createElement("button");
            editLink.setAttribute("data-id", vehicle.id);
            editLink.setAttribute("type", "submit");
            editLink.setAttribute("class", "btn btn-primary");
            editLink.setAttribute("style", "margin-right: 5px;");
            editLink.append("Update");
            editLink.addEventListener("click", async e => {
 
                e.preventDefault();
                await getVehicle(vehicle.id);
            });
            linksTd.append(editLink);
   
            const removeLink = document.createElement("button");
            removeLink.setAttribute("data-id", vehicle.id);
            removeLink.setAttribute("type", "submit");
            removeLink.setAttribute("class", "btn btn-danger");
            removeLink.setAttribute("style", "margin-left: 5px;");
            removeLink.append("Delete");
            removeLink.addEventListener("click", async e => {
   
                e.preventDefault();
                await deleteVehicle(vehicle.id);
            });
   
            linksTd.append(removeLink);
            tr.appendChild(linksTd);
   
            return tr;
        }

        // delete vehicle from the form
        const deleteButtonObject = document.getElementById("deleteButton");
        deleteButtonObject.addEventListener("click", e => {
            if (vehicleId !== 0) deleteVehicle(vehicleId);
        });

        // сброс значений формы
        vehicleForm.addEventListener("reset", e => reset());
   
        // отправка формы
        vehicleForm.addEventListener("submit", e => {
            e.preventDefault();

            const brandmodel_id = vehicleForm.elements["inputBrandmodel"].value;
            const cost = vehicleForm.elements["inputCost"].value;
            const manufactured_year = vehicleForm.elements["inputManufacturedYear"].value;
            const is_in_work = vehicleForm.elements["isInWork"].checked;
            const description = vehicleForm.elements["inputDescription"].value;
            const enterprise_id = vehicleForm.elements["inputEnterpriseId"].value;
            const mileage = vehicleForm.elements["inputMileage"].value;
            if (vehicleId === 0) createVehicle(
                brandmodel_id,
                cost,
                manufactured_year,
                description,
                mileage,
                enterprise_id,
                is_in_work
            );
            else editVehicle(
                vehicleId,
                brandmodel_id,
                cost,
                manufactured_year,
                description,
                mileage,
                enterprise_id,
                is_in_work
            );
        });

        // загрузка пользователей
        getVehicles();
    </script>
</body>
</html>